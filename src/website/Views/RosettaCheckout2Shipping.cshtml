@inherits Merchello.Web.Mvc.MerchelloTemplatePage
@using Controllers
@using Merchello.Core.Gateways.Shipping
@using Merchello.Core.Models
@using Merchello.Web
@{
    Layout = "RosettaBasePage.cshtml";

    // from the previous step we can get the shipping address
    var shippingAddress = CurrentCustomer.Basket().SalePreparation().GetShipToAddress();

    // For version 1.x there will only ever be a single shipment here.
    var shipment = CurrentCustomer.Basket().PackageBasket(shippingAddress).FirstOrDefault();
    
    
}

@if (CurrentPage.HasValue("instructionHeading"))
{
    <h2>@CurrentPage.instructionHeading<br /><small>@CurrentPage.instructionTagLine</small></h2>
}

@(shipment == null ? @RenderCanNotShip() : @RenderSelectShippingOption(shipment))

@helper RenderCanNotShip()
{
    <p>The current basket does not have shippable items</p>
}

@helper RenderSelectShippingOption(IShipment shipment)
{

    var quotes = shipment.ShipmentRateQuotes();

    var shipmentRateQuotes = quotes as IShipmentRateQuote[] ?? quotes.ToArray();
    if (!shipmentRateQuotes.Any())
    {
        // the destination address is not configured to be an "allowed" ship to address in the Merchello Back Office
        <p>Our store cannot ship to your address</p>
    }
    else
    {
        var quoteItems = shipmentRateQuotes.Select(x => new SelectListItem()
            {
                Value = x.ShipMethod.Key.ToString(),
                Text = string.Format("{0} ({1})", x.ShipMethod.Name, x.Rate.ToString("C")) 
            });
        
        <div class="bs-docs-example">
            <div class="row">
                <div class="col-lg-6">
                    @Html.Label("Select your shipment method", new { @class = "control-label"})
                    @using (Html.BeginUmbracoForm<CheckoutController>("SaveApprovedShipmentRateQuote", new { @class = "form form-horizontal", role = "form" }))
                    {
                        @Html.DropDownList("shipMethodKey", quoteItems, new { @class="form-control"})
                    }
                </div>
                <div class="col-lg-6">
                    <h4>Items in the shipment</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Sku</th>
                                <th>Quantity</th>
                                <th>Unit Weight</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in shipment.Items)
                            {
                                <tr>
                                    <td>@item.Name</td>
                                    <td>@item.Sku</td>
                                    <td>@item.Quantity</td>
                                    <td>@item.ExtendedData.GetWeightValue()</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
}